{% extends "base.html" %}

{% block title %}Dashboard - {{ app_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i>
            Panel Principal
        </h1>
        <p class="text-muted mb-0">Resumen general del sistema de pagos</p>
    </div>
    <div>
        <span class="badge bg-light text-dark fs-6">
            <i class="fas fa-calendar me-1"></i>
            {{ resumen.mes_actual if resumen and resumen.mes_actual else 'Mes Actual' }}
        </span>
    </div>
</div>

<!-- Tarjetas de resumen -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title opacity-75 mb-1">Total Estudiantes</h6>
                        <h2 class="mb-0 fw-bold">{{ resumen.total_estudiantes or 0 }}</h2>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="opacity-75">
                        <i class="fas fa-graduation-cap me-1"></i>
                        Estudiantes activos
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title opacity-75 mb-1">Al Día</h6>
                        <h2 class="mb-0 fw-bold">{{ resumen.estudiantes_al_dia or 0 }}</h2>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="opacity-75">
                        <i class="fas fa-percentage me-1"></i>
                        {{ "%.1f"|format(resumen.porcentaje_al_dia or 0) }}% del total
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card danger text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title opacity-75 mb-1">Morosos</h6>
                        <h2 class="mb-0 fw-bold">{{ resumen.estudiantes_morosos or 0 }}</h2>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="opacity-75">
                        <i class="fas fa-clock me-1"></i>
                        Pagos pendientes
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title opacity-75 mb-1">Recaudación</h6>
                        <h2 class="mb-0 fw-bold">Q{{ "%.0f"|format((resumen.estudiantes_al_dia or 0) * 250) }}k</h2>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-money-bill-wave fa-2x"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="opacity-75">
                        <i class="fas fa-chart-line me-1"></i>
                        Estimado mes actual
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos y información detallada -->
<div class="row">
    <!-- Gráfico de pagos por grado -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Estado de Pagos por Grado
                </h5>
            </div>
            <div class="card-body">
                <canvas id="chartPagosGrado" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Acciones Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    {% if current_user.puede_cargar_archivos() %}
                    <a href="{{ url_for('pagos.subir') }}" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>
                        Cargar Archivo de Pagos
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('estudiantes.lista') }}" class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i>
                        Ver Estudiantes
                    </a>
                    
                    <a href="{{ url_for('reportes.index') }}" class="btn btn-outline-success">
                        <i class="fas fa-file-pdf me-2"></i>
                        Generar Reportes
                    </a>
                    
                    {% if current_user.puede_gestionar_usuarios() %}
                    <a href="{{ url_for('usuarios.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-users-cog me-2"></i>
                        Gestionar Usuarios
                    </a>
                    {% endif %}
                </div>
                
                <!-- Información del usuario -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="text-muted mb-2">Tu información:</h6>
                    <p class="mb-1">
                        <strong>{{ current_user.nombre }}</strong>
                    </p>
                    <span class="badge bg-{{ 'primary' if current_user.es_coordinador else 'success' if current_user.es_secretaria else 'info' }}">
                        {{ current_user.rol.title() }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alertas y notificaciones -->
{% if resumen.estudiantes_morosos and resumen.estudiantes_morosos > 0 %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Atención: Estudiantes con pagos pendientes</h5>
                    <p class="mb-0">
                        Hay <strong>{{ resumen.estudiantes_morosos }}</strong> estudiantes con pagos pendientes del mes actual. 
                        <a href="{{ url_for('reportes.index') }}" class="alert-link">Ver reporte detallado</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos reales del gráfico desde el API
    fetch('/dashboard/api/datos-grado')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderChart(data.datos);
            } else {
                console.error('Error cargando datos:', data.error);
                // Fallback a datos de ejemplo
                renderChartFallback();
            }
        })
        .catch(error => {
            console.error('Error en API:', error);
            renderChartFallback();
        });
    
    function renderChart(datos) {
        const ctx = document.getElementById('chartPagosGrado').getContext('2d');
        
        // Extraer datos para el gráfico
        const grados = datos.map(item => item.grado);
        const alDia = datos.map(item => item.al_dia);
        const morosos = datos.map(item => item.morosos);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: grados,
                datasets: [{
                    label: 'Al día',
                    data: alDia,
                    backgroundColor: 'rgba(44, 62, 80, 0.8)', // Azul oscuro formal
                    borderColor: 'rgba(44, 62, 80, 1)',
                    borderWidth: 1
                }, {
                    label: 'Morosos',
                    data: morosos,
                    backgroundColor: 'rgba(200, 54, 54, 0.8)', // Rojo formal
                    borderColor: 'rgba(146, 43, 33, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(44, 62, 80, 0.08)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        console.log('📊 Gráfico actualizado con datos reales');
    }
    
    function renderChartFallback() {
        // Datos de ejemplo como fallback
        const ctx = document.getElementById('chartPagosGrado').getContext('2d');
        const grados = ['Kinder', 'Párvulos', 'Preparatoria', '1° Primaria', '2° Primaria', '3° Primaria', 'Básicos', 'Diversificado'];
        const alDia = [0, 0, 0, 0, 0, 0, 0, 0]; // Sin pagos aún
        const morosos = [5, 37, 47, 53, 52, 49, 258, 91]; // Todos morosos
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: grados,
                datasets: [{
                    label: 'Al día',
                    data: alDia,
                    backgroundColor: 'rgba(44, 62, 80, 0.8)', // Azul oscuro formal
                    borderColor: 'rgba(44, 62, 80, 1)',
                    borderWidth: 1
                }, {
                    label: 'Morosos',
                    data: morosos,
                    backgroundColor: 'rgba(200, 54, 54, 0.8)', // Rojo formal
                    borderColor: 'rgba(146, 43, 33, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(44, 62, 80, 0.08)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        console.log('📊 Gráfico con datos de fallback (sin pagos procesados)');
    }
});
</script>
{% endblock %}